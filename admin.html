<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lightframer Pro ‚Äî Camera Database Admin</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg: #0d0d0d; --bg2: #161616; --bg3: #1e1e1e; --bg4: #282828;
  --text: #e0e0e0; --text2: #888; --accent: #e8a84c; --accent2: #c4863a;
  --red: #e05252; --green: #4caf50; --blue: #5c9ce6; --border: #333;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }

/* Auth screen */
#auth-screen { display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 16px; }
#auth-screen h1 { font-size: 18px; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }
#auth-screen input { padding: 12px 20px; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px; width: 300px; text-align: center; }
#auth-screen input:focus { outline: none; border-color: var(--accent); }
#auth-screen .error { color: var(--red); font-size: 13px; min-height: 20px; }
#auth-screen button { padding: 10px 32px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }

/* App layout */
#app { display: none; height: 100vh; overflow: hidden; }
#app.visible { display: flex; }

/* Sidebar */
#sidebar { width: 320px; min-width: 320px; background: var(--bg2); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
#sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
#sidebar-header h1 { font-size: 14px; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
#search { width: 100%; padding: 8px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; outline: none; }
#search:focus { border-color: var(--accent); }
#filter-bar { padding: 8px 16px; display: flex; gap: 6px; flex-wrap: wrap; }
.filter-btn { padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-size: 10px; cursor: pointer; text-transform: uppercase; }
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(232,168,76,0.1); }
#sidebar-stats { padding: 6px 16px; font-size: 11px; color: var(--text2); border-bottom: 1px solid var(--border); }
#sidebar-actions { padding: 8px 16px; display: flex; gap: 8px; flex-wrap: wrap; }
#camera-list { flex: 1; overflow-y: auto; padding: 4px 0; }
.mfg-group { margin-bottom: 2px; }
.mfg-header { padding: 6px 16px; font-size: 11px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; }
.mfg-header:hover { color: var(--accent); }
.cam-item { padding: 8px 16px 8px 28px; font-size: 13px; cursor: pointer; border-left: 3px solid transparent; transition: all .15s; display: flex; justify-content: space-between; align-items: center; }
.cam-item:hover { background: var(--bg3); }
.cam-item.active { background: var(--bg3); border-left-color: var(--accent); color: var(--accent); }
.cam-item .cam-info { flex: 1; }
.cam-item .cam-meta { font-size: 11px; color: var(--text2); }

/* Main */
#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#content { flex: 1; overflow-y: auto; padding: 24px; }

/* Buttons */
.btn { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg3); color: var(--text); font-size: 12px; cursor: pointer; transition: all .15s; }
.btn:hover { background: var(--bg4); border-color: var(--accent); }
.btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
.btn-primary:hover { background: var(--accent2); }
.btn-danger { border-color: var(--red); color: var(--red); }
.btn-danger:hover { background: var(--red); color: #fff; }
.btn-success { border-color: var(--green); color: var(--green); }
.btn-success:hover { background: var(--green); color: #fff; }
.btn-sm { padding: 4px 10px; font-size: 11px; }

/* Camera detail */
.cam-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
.cam-header h2 { font-size: 24px; font-weight: 600; }
.cam-header .meta { color: var(--text2); font-size: 13px; margin-top: 4px; }
.cam-props { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
.prop { background: var(--bg3); padding: 12px; border-radius: 8px; }
.prop label { font-size: 11px; color: var(--text2); text-transform: uppercase; display: block; margin-bottom: 4px; }
.prop .val { font-size: 16px; font-weight: 500; }

/* Verification */
.verify-section { background: var(--bg3); border-radius: 8px; padding: 16px; margin-bottom: 24px; border: 1px solid var(--border); }
.verify-section h4 { font-size: 13px; color: var(--accent); text-transform: uppercase; margin-bottom: 12px; }
.verify-row { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 8px; flex-wrap: wrap; }
.verify-row label { font-size: 12px; color: var(--text2); min-width: 100px; padding-top: 6px; }
.verify-row input, .verify-row textarea { flex: 1; min-width: 200px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px; font-family: inherit; }
.verify-row input:focus, .verify-row textarea:focus { outline: none; border-color: var(--accent); }
.verify-row textarea { min-height: 50px; resize: vertical; }

/* Table */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
th { text-align: left; padding: 8px 10px; color: var(--text2); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg); z-index: 2; }
td { padding: 6px 10px; border-bottom: 1px solid var(--border); }
tr:hover td { background: var(--bg3); }
tr.verified td { border-left: 2px solid var(--green); }
tr.unverified td { border-left: 2px solid var(--red); }
tr.flagged td { background: rgba(232,168,76,0.06); border-left: 2px solid var(--accent); }
td input.ie { width: 65px; padding: 2px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; color: var(--text); font-size: 12px; text-align: right; }
td input.ie:focus { border-color: var(--accent); outline: none; }
td input.ie-w { width: 150px; text-align: left; }
.aspect { color: var(--text2); font-size: 11px; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
.modal h3 { font-size: 18px; margin-bottom: 16px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group.full { grid-column: 1 / -1; }
.form-group label { font-size: 11px; color: var(--text2); text-transform: uppercase; }
.form-group input, .form-group select, .form-group textarea { padding: 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; font-family: inherit; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
.form-group textarea { min-height: 60px; resize: vertical; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

/* Toast */
#toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; background: var(--bg3); border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); font-size: 13px; opacity: 0; transition: opacity .3s; z-index: 200; pointer-events: none; }
#toast.show { opacity: 1; }

.empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text2); font-size: 16px; gap: 8px; }

/* Unsaved indicator */
#save-indicator { position: fixed; top: 12px; right: 12px; padding: 6px 12px; background: var(--green); color: #000; font-size: 11px; font-weight: 600; border-radius: 6px; opacity: 0; transition: opacity .3s; z-index: 200; }
#save-indicator.show { opacity: 1; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

@media (max-width: 768px) {
  #app.visible { flex-direction: column; }
  #sidebar { width: 100%; min-width: 0; max-height: 40vh; }
  #content { padding: 12px; }
}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <h1>üé¨ Lightframer Pro</h1>
  <p style="color:var(--text2);font-size:13px">Camera Database Admin</p>
  <input id="pw-input" type="password" placeholder="Enter password" autofocus>
  <div class="error" id="pw-error"></div>
  <button onclick="tryAuth()">Enter</button>
</div>

<!-- App -->
<div id="app">
  <div id="sidebar">
    <div id="sidebar-header">
      <h1>üé¨ Camera Database</h1>
      <input id="search" type="text" placeholder="Search cameras...">
    </div>
    <div id="filter-bar">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-btn" data-filter="unverified" onclick="setFilter('unverified')">‚ùå Unverified</button>
      <button class="filter-btn" data-filter="verified" onclick="setFilter('verified')">‚úÖ Verified</button>
      <button class="filter-btn" data-filter="flagged" onclick="setFilter('flagged')">‚ö†Ô∏è Flagged</button>
    </div>
    <div id="sidebar-stats"></div>
    <div id="sidebar-actions">
      <button class="btn btn-primary btn-sm" onclick="showAddCamera()">+ Camera</button>
      <button class="btn btn-sm" onclick="exportCSV()">üìä Export CSV</button>
      <button class="btn btn-sm" onclick="exportJSON()">üíæ Export JSON</button>
      <button class="btn btn-sm" onclick="importJSON()">üìÇ Import JSON</button>
    </div>
    <div id="camera-list"></div>
  </div>
  <div id="main">
    <div id="content">
      <div class="empty">
        <div>Select a camera from the sidebar</div>
        <div style="font-size:13px;color:var(--text2)">Your changes auto-save to browser storage</div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="save-indicator">Saved ‚úì</div>
<input type="file" id="file-import" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
// --- AUTH ---
const PASS_HASH = '073d1c96a79049eea0de55f71d1f13c58ac8a6b9ce4f6cb67e100b5f6837008d'; // sha256 of "lightframer2026"

async function sha256(msg) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function tryAuth() {
  const pw = document.getElementById('pw-input').value;
  const hash = await sha256(pw);
  if (hash === PASS_HASH) {
    sessionStorage.setItem('lf-auth', '1');
    showApp();
  } else {
    document.getElementById('pw-error').textContent = 'Incorrect password';
  }
}
document.getElementById('pw-input').addEventListener('keydown', e => { if (e.key === 'Enter') tryAuth(); });

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  init();
}

if (sessionStorage.getItem('lf-auth')) showApp();

// --- APP ---
let cameras = [];
let selectedId = null;
let currentFilter = 'all';
let saveTimer = null;
const LS_KEY = 'lf-cameras-data';

const MFG_LIST = ['ARRI','RED','Sony','Blackmagic','Canon','Panasonic','Panavision','DJI','Kinefinity','Z CAM','Nikon','Fujifilm','Freefly','Phantom','Film','AJA','Digital Bolex','Ikonoskop','Silicon Imaging','Weisscam','PS-Cam'];
const CAT_LIST = ['Large Format','Full Frame','Vista Vision','Super 35','Medium Format','APS-C','Micro Four Thirds','Super 16','Film 35mm','Film 65mm','Film 16mm','Film 8mm'];

function toast(msg, ms=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
}

function flashSaved() {
  const el = document.getElementById('save-indicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

// Persistence: localStorage
function saveData() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    localStorage.setItem(LS_KEY, JSON.stringify({ cameras }));
    flashSaved();
    renderStats();
  }, 300);
}

async function init() {
  // Load from localStorage first, fallback to server JSON
  const stored = localStorage.getItem(LS_KEY);
  if (stored) {
    try {
      cameras = JSON.parse(stored).cameras;
      renderAll();
      return;
    } catch(e) {}
  }
  // Fetch from static JSON
  try {
    const r = await fetch('/cameras.json');
    const data = await r.json();
    cameras = data.cameras;
    localStorage.setItem(LS_KEY, JSON.stringify({ cameras }));
    renderAll();
  } catch(e) {
    toast('Failed to load camera data');
  }
}

function renderAll() {
  renderSidebar();
  renderStats();
  if (selectedId) renderDetail(selectedId);
}

// Stats
function renderStats() {
  const total = cameras.length;
  const verified = cameras.filter(c => c.verified).length;
  const modes = cameras.reduce((s,c) => s + c.sensorModes.length, 0);
  const verifiedModes = cameras.reduce((s,c) => s + c.sensorModes.filter(m => m.verified).length, 0);
  document.getElementById('sidebar-stats').innerHTML = `
    <strong>${verified}/${total}</strong> cameras ¬∑ <strong>${verifiedModes}/${modes}</strong> modes verified
  `;
}

// Filter
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
  renderSidebar();
}
function filterCamera(c) {
  if (currentFilter === 'verified') return c.verified;
  if (currentFilter === 'unverified') return !c.verified;
  if (currentFilter === 'flagged') return (c.notes && c.notes.trim()) || c.sensorModes.some(m => m.notes && m.notes.trim());
  return true;
}

// Sidebar
function renderSidebar() {
  const q = document.getElementById('search').value.toLowerCase();
  const groups = {};
  cameras.filter(c => {
    const s = `${c.manufacturer} ${c.model} ${c.id}`.toLowerCase();
    return (!q || s.includes(q)) && filterCamera(c);
  }).forEach(c => {
    if (!groups[c.manufacturer]) groups[c.manufacturer] = [];
    groups[c.manufacturer].push(c);
  });
  document.getElementById('camera-list').innerHTML = Object.entries(groups).sort((a,b) => a[0].localeCompare(b[0])).map(([mfg, cams]) => {
    const v = cams.filter(c => c.verified).length;
    return `<div class="mfg-group">
      <div class="mfg-header">${mfg} <span style="font-weight:400">${v}/${cams.length} ‚úì</span></div>
      ${cams.map(c => {
        const mv = c.sensorModes.filter(m=>m.verified).length;
        const st = c.verified ? '‚úÖ' : (c.notes ? '‚ö†Ô∏è' : '‚ùå');
        return `<div class="cam-item ${c.id===selectedId?'active':''}" onclick="selectCamera('${c.id}')">
          <div class="cam-info">${c.model}<div class="cam-meta">${c.sensorModes.length} modes ¬∑ ${mv}/${c.sensorModes.length} ‚úì</div></div>
          <div>${st}</div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
}
document.getElementById('search').addEventListener('input', renderSidebar);

function selectCamera(id) { selectedId = id; renderSidebar(); renderDetail(id); }

function aspectStr(w, h) {
  const r = w / h;
  if (Math.abs(r - 16/9) < 0.03) return '16:9';
  if (Math.abs(r - 17/9) < 0.03) return '17:9';
  if (Math.abs(r - 2.39) < 0.05) return '2.39:1';
  if (Math.abs(r - 2.0) < 0.05) return '2:1';
  if (Math.abs(r - 4/3) < 0.03) return '4:3';
  if (Math.abs(r - 3/2) < 0.03) return '3:2';
  if (Math.abs(r - 1) < 0.03) return '1:1';
  if (Math.abs(r - 5/4) < 0.03) return '5:4';
  return r.toFixed(2) + ':1';
}

// Detail
function renderDetail(id) {
  const cam = cameras.find(c => c.id === id);
  if (!cam) return;
  document.getElementById('content').innerHTML = `
    <div class="cam-header">
      <div>
        <h2>${cam.manufacturer} ${cam.model}</h2>
        <div class="meta">${cam.id} ¬∑ ${cam.category} ¬∑ ${cam.releaseYear}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-sm btn-success" onclick="toggleCamVerified('${cam.id}')">${cam.verified ? '‚úÖ Verified' : '‚òê Mark Verified'}</button>
        <button class="btn btn-sm" onclick="showEditCamera('${cam.id}')">‚úè Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCam('${cam.id}')">üóë Delete</button>
      </div>
    </div>
    <div class="verify-section">
      <h4>Verification Info</h4>
      <div class="verify-row">
        <label>Source URL</label>
        <input value="${cam.sourceUrl||''}" placeholder="Manufacturer spec page URL" onchange="camField('${cam.id}','sourceUrl',this.value)">
      </div>
      <div class="verify-row">
        <label>Notes</label>
        <textarea placeholder="Issues found, verification notes..." onchange="camField('${cam.id}','notes',this.value)">${cam.notes||''}</textarea>
      </div>
    </div>
    <div class="cam-props">
      <div class="prop"><label>ISO Base</label><div class="val">${cam.isoBase}</div></div>
      <div class="prop"><label>Dual ISO</label><div class="val">${cam.isoDualBase || '‚Äî'}</div></div>
      <div class="prop"><label>Dynamic Range</label><div class="val">${cam.dynamicRange} stops</div></div>
      <div class="prop"><label>Mount</label><div class="val">${cam.mount}</div></div>
      <div class="prop"><label>Modes</label><div class="val">${cam.sensorModes.filter(m=>m.verified).length}/${cam.sensorModes.length} verified</div></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <h3 style="font-size:16px">Sensor Modes</h3>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-success" onclick="verifyAllModes('${cam.id}')">‚úÖ Verify All</button>
        <button class="btn btn-sm btn-primary" onclick="showAddMode('${cam.id}')">+ Add Mode</button>
      </div>
    </div>
    <div class="table-wrap">
    <table>
      <tr><th>‚úì</th><th>Name</th><th>Sensor (mm)</th><th>Aspect</th><th>Resolution</th><th>FPS</th><th>Crop</th><th>Notes</th><th></th></tr>
      ${cam.sensorModes.map((m,i) => {
        const cls = m.verified ? 'verified' : (m.notes ? 'flagged' : 'unverified');
        return `<tr class="${cls}">
          <td><input type="checkbox" ${m.verified?'checked':''} onchange="toggleModeV('${cam.id}',${i},this.checked)"></td>
          <td><input class="ie ie-w" value="${m.name}" onchange="modeField('${cam.id}',${i},'name',this.value)"></td>
          <td><input class="ie" value="${m.sensorWidth}" onchange="modeNum('${cam.id}',${i},'sensorWidth',this.value)"> √ó <input class="ie" value="${m.sensorHeight}" onchange="modeNum('${cam.id}',${i},'sensorHeight',this.value)"></td>
          <td><span class="aspect">${aspectStr(m.sensorWidth,m.sensorHeight)}</span></td>
          <td>${m.resolutionWidth}√ó${m.resolutionHeight}</td>
          <td><input class="ie" style="width:45px" value="${m.maxFPS}" onchange="modeNum('${cam.id}',${i},'maxFPS',this.value)"></td>
          <td><input class="ie" style="width:45px" value="${m.cropFactor}" onchange="modeNum('${cam.id}',${i},'cropFactor',this.value)"></td>
          <td><input class="ie ie-w" value="${m.notes||''}" placeholder="Notes..." onchange="modeField('${cam.id}',${i},'notes',this.value)"></td>
          <td><button class="btn btn-sm btn-danger" onclick="delMode('${cam.id}',${i})">‚úï</button></td>
        </tr>`;
      }).join('')}
    </table>
    </div>
  `;
}

// Edit helpers
function camField(id, f, v) { cameras.find(c=>c.id===id)[f] = v; saveData(); }
function modeField(id, i, f, v) { cameras.find(c=>c.id===id).sensorModes[i][f] = v; saveData(); }
function modeNum(id, i, f, v) { cameras.find(c=>c.id===id).sensorModes[i][f] = parseFloat(v); saveData(); renderDetail(id); }
function toggleCamVerified(id) { const c = cameras.find(x=>x.id===id); c.verified = !c.verified; saveData(); renderDetail(id); renderSidebar(); }
function toggleModeV(id, i, checked) { cameras.find(c=>c.id===id).sensorModes[i].verified = checked; saveData(); renderSidebar(); }
function verifyAllModes(id) {
  const c = cameras.find(x=>x.id===id);
  const all = c.sensorModes.every(m=>m.verified);
  c.sensorModes.forEach(m => m.verified = !all);
  saveData(); renderDetail(id); renderSidebar();
}
function deleteCam(id) {
  if (!confirm('Delete this camera?')) return;
  cameras = cameras.filter(c => c.id !== id);
  selectedId = null; saveData(); renderAll();
  document.getElementById('content').innerHTML = '<div class="empty">Select a camera</div>';
}
function delMode(id, i) {
  const c = cameras.find(x=>x.id===id);
  if (!confirm(`Delete "${c.sensorModes[i].name}"?`)) return;
  c.sensorModes.splice(i, 1); saveData(); renderDetail(id); renderSidebar();
}

// Modals
function showModal(html) {
  const o = document.createElement('div'); o.className = 'modal-overlay';
  o.innerHTML = `<div class="modal">${html}</div>`;
  o.addEventListener('click', e => { if (e.target === o) o.remove(); });
  document.body.appendChild(o);
}
function closeModal() { document.querySelector('.modal-overlay')?.remove(); }

function showAddCamera() {
  showModal(`<h3>Add Camera</h3>
    <div class="form-grid">
      <div class="form-group"><label>ID</label><input id="f-id" placeholder="brand_model"></div>
      <div class="form-group"><label>Manufacturer</label><select id="f-mfg">${MFG_LIST.map(m=>`<option>${m}</option>`).join('')}</select></div>
      <div class="form-group"><label>Model</label><input id="f-model"></div>
      <div class="form-group"><label>Category</label><select id="f-cat">${CAT_LIST.map(c=>`<option>${c}</option>`).join('')}</select></div>
      <div class="form-group"><label>ISO Base</label><input id="f-iso" type="number" value="800"></div>
      <div class="form-group"><label>Dual ISO</label><input id="f-dualiso" type="number"></div>
      <div class="form-group"><label>Dynamic Range</label><input id="f-dr" type="number" step="0.1" value="14.0"></div>
      <div class="form-group"><label>Mount</label><input id="f-mount" value="PL"></div>
      <div class="form-group"><label>Release Year</label><input id="f-year" type="number" value="2024"></div>
      <div class="form-group full"><label>Source URL</label><input id="f-url"></div>
    </div>
    <div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="addCam()">Add</button></div>`);
}
function addCam() {
  const cam = { id:document.getElementById('f-id').value, manufacturer:document.getElementById('f-mfg').value, model:document.getElementById('f-model').value, category:document.getElementById('f-cat').value, isoBase:+document.getElementById('f-iso').value, isoDualBase:document.getElementById('f-dualiso').value?+document.getElementById('f-dualiso').value:null, dynamicRange:+document.getElementById('f-dr').value, mount:document.getElementById('f-mount').value, releaseYear:+document.getElementById('f-year').value, sensorModes:[], verified:false, sourceUrl:document.getElementById('f-url').value, notes:'' };
  if (!cam.id||!cam.model) return toast('ID and Model required');
  if (cameras.find(c=>c.id===cam.id)) return toast('ID already exists');
  cameras.push(cam); saveData(); closeModal(); renderAll(); selectCamera(cam.id);
}

function showEditCamera(id) {
  const c = cameras.find(x=>x.id===id);
  showModal(`<h3>Edit Camera</h3>
    <div class="form-grid">
      <div class="form-group"><label>ID</label><input id="f-id" value="${c.id}" readonly style="opacity:.5"></div>
      <div class="form-group"><label>Manufacturer</label><select id="f-mfg">${MFG_LIST.map(m=>`<option ${m===c.manufacturer?'selected':''}>${m}</option>`).join('')}</select></div>
      <div class="form-group"><label>Model</label><input id="f-model" value="${c.model}"></div>
      <div class="form-group"><label>Category</label><select id="f-cat">${CAT_LIST.map(x=>`<option ${x===c.category?'selected':''}>${x}</option>`).join('')}</select></div>
      <div class="form-group"><label>ISO Base</label><input id="f-iso" type="number" value="${c.isoBase}"></div>
      <div class="form-group"><label>Dual ISO</label><input id="f-dualiso" type="number" value="${c.isoDualBase||''}"></div>
      <div class="form-group"><label>Dynamic Range</label><input id="f-dr" type="number" step="0.1" value="${c.dynamicRange}"></div>
      <div class="form-group"><label>Mount</label><input id="f-mount" value="${c.mount}"></div>
      <div class="form-group"><label>Release Year</label><input id="f-year" type="number" value="${c.releaseYear}"></div>
    </div>
    <div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveCam('${c.id}')">Save</button></div>`);
}
function saveCam(id) {
  const c = cameras.find(x=>x.id===id);
  Object.assign(c, { manufacturer:document.getElementById('f-mfg').value, model:document.getElementById('f-model').value, category:document.getElementById('f-cat').value, isoBase:+document.getElementById('f-iso').value, isoDualBase:document.getElementById('f-dualiso').value?+document.getElementById('f-dualiso').value:null, dynamicRange:+document.getElementById('f-dr').value, mount:document.getElementById('f-mount').value, releaseYear:+document.getElementById('f-year').value });
  saveData(); closeModal(); renderAll();
}

function showAddMode(camId) {
  showModal(`<h3>Add Sensor Mode</h3>
    <div class="form-grid">
      <div class="form-group full"><label>ID</label><input id="fm-id"></div>
      <div class="form-group full"><label>Name</label><input id="fm-name"></div>
      <div class="form-group"><label>Sensor Width mm</label><input id="fm-sw" type="number" step="0.01"></div>
      <div class="form-group"><label>Sensor Height mm</label><input id="fm-sh" type="number" step="0.01"></div>
      <div class="form-group"><label>Res Width px</label><input id="fm-rw" type="number"></div>
      <div class="form-group"><label>Res Height px</label><input id="fm-rh" type="number"></div>
      <div class="form-group"><label>Max FPS</label><input id="fm-fps" type="number"></div>
      <div class="form-group"><label>Crop Factor</label><input id="fm-crop" type="number" step="0.01" value="1.0"></div>
    </div>
    <div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="addMode2('${camId}')">Add</button></div>`);
}
function addMode2(camId) {
  const m = { id:document.getElementById('fm-id').value, name:document.getElementById('fm-name').value, sensorWidth:+document.getElementById('fm-sw').value, sensorHeight:+document.getElementById('fm-sh').value, resolutionWidth:+document.getElementById('fm-rw').value, resolutionHeight:+document.getElementById('fm-rh').value, maxFPS:+document.getElementById('fm-fps').value, cropFactor:+document.getElementById('fm-crop').value, verified:false, sourceUrl:'', notes:'' };
  if (!m.id||!m.name) return toast('ID and Name required');
  cameras.find(c=>c.id===camId).sensorModes.push(m);
  saveData(); closeModal(); renderDetail(camId); renderSidebar();
}

// Export CSV
function exportCSV() {
  let csv = 'Camera ID,Manufacturer,Model,Category,Mode ID,Mode Name,Sensor Width (mm),Sensor Height (mm),Aspect Ratio,Resolution Width,Resolution Height,Max FPS,Crop Factor,Camera Verified,Mode Verified,Source URL,Camera Notes,Mode Notes\n';
  cameras.forEach(cam => {
    cam.sensorModes.forEach(m => {
      csv += `"${cam.id}","${cam.manufacturer}","${cam.model}","${cam.category}","${m.id}","${m.name}",${m.sensorWidth},${m.sensorHeight},"${aspectStr(m.sensorWidth,m.sensorHeight)}",${m.resolutionWidth},${m.resolutionHeight},${m.maxFPS},${m.cropFactor},${cam.verified},${m.verified},"${cam.sourceUrl||''}","${(cam.notes||'').replace(/"/g,'""')}","${(m.notes||'').replace(/"/g,'""')}"\n`;
    });
  });
  dl(csv, 'lightframer-cameras.csv', 'text/csv');
  toast('CSV exported!');
}

// Export/Import JSON
function exportJSON() {
  dl(JSON.stringify({cameras}, null, 2), 'lightframer-cameras.json', 'application/json');
  toast('JSON exported!');
}
function importJSON() { document.getElementById('file-import').click(); }
function handleImport(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (data.cameras) { cameras = data.cameras; saveData(); renderAll(); toast(`Imported ${cameras.length} cameras`); }
      else toast('Invalid format');
    } catch(e) { toast('Parse error'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function dl(content, name, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>
